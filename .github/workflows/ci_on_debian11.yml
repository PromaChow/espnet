name: ci on debian11
on:
  push:
    branches:
      - mas

jobs:
  unit_test_espnet1_and_espnet2_on_debian11:
    container:
      env:
        CHAINER_VERSION: 6.0.0
        ESPNET_PYTHON_VERSION: "3.10"
        LC_ALL: en_US.UTF-8
        TH_VERSION: 1.13.1
        USE_CONDA: true
      image: debian:11
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - name: Start Energy Measurement
        uses: green-coding-solutions/eco-ci-energy-estimation@862050e4f01f65b1436e5eca18ba4bd85562f0de
        with:
          json-output: true
          task: start-measurement
      - uses: actions/checkout@master
      - name: check OS
        run: cat /etc/os-release
      - id: measurement-3
        name: Record Measurement After check OS
        uses: green-coding-solutions/eco-ci-energy-estimation@862050e4f01f65b1436e5eca18ba4bd85562f0de
        with:
          json-output: true
          label: check OS
          task: get-measurement
      - name: install dependencies
        run:
          "apt-get update -qq\n# NOTE(kamo): cmake sndfile will be download using\
          \ anacond:\napt-get install -qq -y \\\n  build-essential git unzip bzip2\
          \ wget curl bc locales make sox \\\n  libncurses5-dev automake libtool pkg-config\n\
          localedef -f UTF-8 -i en_US en_US\n"
      - id: measurement-5
        name: Record Measurement After install dependencies
        uses: green-coding-solutions/eco-ci-energy-estimation@862050e4f01f65b1436e5eca18ba4bd85562f0de
        with:
          json-output: true
          label: install dependencies
          task: get-measurement
      - id: pr-labels
        name: Get PR labels
        uses: joerick/pr-labels-action@v1.0.9
      - name: install espnet
        run: ./ci/install.sh
      - id: measurement-8
        name: Record Measurement After install espnet
        uses: green-coding-solutions/eco-ci-energy-estimation@862050e4f01f65b1436e5eca18ba4bd85562f0de
        with:
          json-output: true
          label: install espnet
          task: get-measurement
      - name: test shell
        run: "./ci/test_shell_espnet1.sh

          ./ci/test_shell_espnet2.sh

          "
      - id: measurement-10
        name: Record Measurement After test shell
        uses: green-coding-solutions/eco-ci-energy-estimation@862050e4f01f65b1436e5eca18ba4bd85562f0de
        with:
          json-output: true
          label: test shell
          task: get-measurement
      - name: test python
        run: "./ci/test_python_espnet1.sh

          ./ci/test_python_espnet2.sh

          ./ci/test_python_espnetez.sh

          "
      - id: measurement-12
        name: Record Measurement After test python
        uses: green-coding-solutions/eco-ci-energy-estimation@862050e4f01f65b1436e5eca18ba4bd85562f0de
        with:
          json-output: true
          label: test python
          task: get-measurement
      - id: display-measurement
        name: Display Energy Results
        uses: green-coding-solutions/eco-ci-energy-estimation@862050e4f01f65b1436e5eca18ba4bd85562f0de
        with:
          json-output: true
          task: display-results
      - name: Save Total Energy Consumption Data
        run: echo '${{ steps.final-measurement.outputs.data-total-json }}' > total_energy_consumption.json
      - name: Upload Energy Consumption Artifact
        uses: actions/upload-artifact@v4
        with:
          name: total-energy-consumption
          path: total_energy_consumption.json
